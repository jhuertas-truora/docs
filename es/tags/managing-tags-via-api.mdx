## Guía para Desarrolladores: Gestionar Etiquetas de Perfil vía API

Esta guía describe el flujo de trabajo de dos pasos de la API para gestionar programáticamente las etiquetas asignadas a un perfil de usuario específico. Todo el proceso, desde verificar el estado actual de un usuario hasta modificar sus etiquetas, puede ser completamente automatizado usando dos endpoints clave.

### Paso 1: Verificar el Estado Actual de Etiquetas de un Perfil

Antes de agregar o eliminar etiquetas, es una mejor práctica recuperar el estado actual del perfil para evitar operaciones redundantes y tener un rastro de auditoría claro.

El endpoint [Obtener historial de etiquetas del cliente](/es/api-reference/endpoint/tags/getCustomerTagsHistory) proporciona un registro cronológico de todos los cambios de etiquetas para un usuario, con la entrada más reciente representando su conjunto actual de etiquetas asignadas.

* **Endpoint:** `GET /getCustomerTagsHistory`
* **Caso de Uso:** Un servicio backend necesita verificar si un usuario con ID `USP1138` ya está marcado con la etiqueta "Riesgo de Abandono" antes de activar un flujo de trabajo de retención. Una llamada a este endpoint proporcionará esa información.

<InfoBox type="info">
  **Documentación de Referencia**
  <br />
  Para parámetros detallados y ejemplos de respuesta, consulta la documentación completa en **[Obtener historial de etiquetas del cliente](/es/api-reference/endpoint/tags/getCustomerTagsHistory)**.
</InfoBox>

### Paso 2: Agregar o Eliminar Etiquetas de un Perfil

Todas las modificaciones a las etiquetas asignadas de un usuario son manejadas por el endpoint [Actualizar Etiquetas del Cliente](/es/api-reference/endpoint/tags/updateCustomerTags). Este único endpoint se usa para realizar tanto acciones de "agregar" como de "eliminar".

* **Endpoint:** `POST /updateCustomerTags`
* **Caso de Uso:** Un representante de ventas cierra un trato en el CRM. El estado del prospecto se actualiza de "Prospecto" a "Cliente". Un webhook del CRM activa un proceso automatizado en tu backend.

#### Creación Automática de Etiquetas (Lógica Upsert)

Este endpoint incluye funcionalidad inteligente de "upsert" (actualizar o insertar) para simplificar la gestión de etiquetas. El comportamiento es el siguiente:

* **Al agregar una etiqueta que no existe:** Si envías una acción `"add"` con un `name` de etiqueta que aún no está en el sistema, el endpoint **creará automáticamente esa etiqueta primero** y luego la asignará al perfil. No necesitas una llamada de "crear" separada.
* **Al agregar una etiqueta que ya existe:** Si envías una acción `"add"` con un `name` de etiqueta que ya existe, el endpoint **no creará un duplicado**. Encontrará la etiqueta existente y simplemente la asignará al perfil.
* **Al eliminar una etiqueta:** La acción `"remove"` solo desvincula la etiqueta del perfil especificado. **No elimina la etiqueta** del sistema general. La etiqueta seguirá estando disponible para ser asignada a otros perfiles.

#### Caso de Uso: Agregar una Etiqueta

Para asignar una etiqueta a un usuario, envía una solicitud especificando el ID del usuario y los detalles de la etiqueta que quieres agregar con la acción `"add"`.

* **Ejemplo:** Asignar la etiqueta "Soporte Prioritario" a un cliente. Si "Soporte Prioritario" no existe, esta llamada la creará y luego la asignará.
    ```json
    // POST /updateCustomerTags
    {
      "action": "add",
      "name": "Soporte Prioritario",
      "color": "#e67e22",
      "source": "external-system",
      "source_type": "Zendesk"
    }
    ```

#### Caso de Uso: Eliminar una Etiqueta

Para eliminar una etiqueta de un usuario, especifica el nombre de la etiqueta y la acción `"remove"`.

* **Ejemplo:** Eliminar la etiqueta "Prospecto Caliente" del perfil de un cliente.
    ```json
    // POST /updateCustomerTags
    {
      "action": "remove",
      "name": "Prospecto Caliente",
      "source": "profile"
    }
    ```

<InfoBox type="info">
  **Documentación de Referencia**
  <br />
  Para ver la estructura completa de la solicitud, parámetros y ejemplos, consulta la documentación en **[Actualizar Etiquetas del Cliente](/es/api-reference/endpoint/tags/updateCustomerTags)**.
</InfoBox>
